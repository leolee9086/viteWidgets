{"version":3,"file":"equirectangular-video.js","sources":["../../src/adapters/shared/AbstractVideoAdapter.js","../../src/adapters/equirectangular-video/index.js"],"sourcesContent":["import { VideoTexture } from 'three';\nimport { AbstractAdapter, CONSTANTS, PSVError } from '../..';\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n */\n\n/**\n * @summary Base video adapters class\n * @memberof PSV.adapters\n * @abstract\n * @private\n */\nexport class AbstractVideoAdapter extends AbstractAdapter {\n\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.adapters.AbstractVideoAdapter.Options}\n     * @private\n     */\n    this.config = {\n      autoplay: false,\n      muted   : options?.autoplay ?? false,\n      ...options,\n    };\n\n    /**\n     * @member {HTMLVideoElement}\n     * @private\n     */\n    this.video = null;\n\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @override\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    this.__removeVideo();\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    /* eslint-disable */\n    switch (e.type) {\n      case CONSTANTS.EVENTS.BEFORE_RENDER:\n        if (this.video) {\n          this.psv.needsUpdate();\n        }\n        break;\n    }\n    /* eslint-enable */\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.AbstractVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    if (typeof panorama !== 'object' || !panorama.source) {\n      return Promise.reject(new PSVError('Invalid panorama configuration, are you using the right adapter?'));\n    }\n\n    if (!this.psv.getPlugin('video')) {\n      return Promise.reject(new PSVError('Video adapters require VideoPlugin to be loaded too.'));\n    }\n\n    const video = this.__createVideo(panorama.source);\n\n    return this.__videoLoadPromise(video)\n      .then(() => {\n        const texture = new VideoTexture(video);\n        return { panorama, texture };\n      });\n  }\n\n  /**\n   * @override\n   */\n  __switchVideo(texture) {\n    let currentTime;\n    let duration;\n    let paused = !this.config.autoplay;\n    let muted = this.config.muted;\n    let volume = 1;\n    if (this.video) {\n      ({ currentTime, duration, paused, muted, volume } = this.video);\n    }\n\n    this.__removeVideo();\n    this.video = texture.image;\n\n    // keep current time when switching resolution\n    if (this.video.duration === duration) {\n      this.video.currentTime = currentTime;\n    }\n\n    // keep volume\n    this.video.muted = muted;\n    this.video.volume = volume;\n\n    // play\n    if (!paused) {\n      this.video.play();\n    }\n  }\n\n  /**\n   * @override\n   */\n  disposeTexture(textureData) {\n    if (textureData.texture) {\n      const video = textureData.texture.image;\n      video.pause();\n      this.psv.container.removeChild(video);\n    }\n    textureData.texture?.dispose();\n  }\n\n  /**\n   * @summary Removes the current video element\n   * @private\n   */\n  __removeVideo() {\n    if (this.video) {\n      this.video.pause();\n      this.psv.container.removeChild(this.video);\n      delete this.video;\n    }\n  }\n\n  /**\n   * @summary Creates a new video element\n   * @memberOf PSV.adapters\n   * @param {string} src\n   * @return {HTMLVideoElement}\n   * @private\n   */\n  __createVideo(src) {\n    const video = document.createElement('video');\n    video.crossOrigin = this.psv.config.withCredentials ? 'use-credentials' : 'anonymous';\n    video.loop = true;\n    video.playsinline = true;\n    video.style.display = 'none';\n    video.muted = this.config.muted;\n    video.src = src;\n    video.preload = 'metadata';\n\n    this.psv.container.appendChild(video);\n\n    return video;\n  }\n\n  /**\n   * @private\n   */\n  __videoLoadPromise(video) {\n    const self = this;\n\n    return new Promise((resolve, reject) => {\n      video.addEventListener('loadedmetadata', function onLoaded() {\n        if (this.video && video.duration === this.video.duration) {\n          resolve(self.__videoBufferPromise(video, this.video.currentTime));\n        }\n        else {\n          resolve();\n        }\n        video.removeEventListener('loadedmetadata', onLoaded);\n      });\n\n      video.addEventListener('error', function onError(err) {\n        reject(err);\n        video.removeEventListener('error', onError);\n      });\n    });\n  }\n\n  /**\n   * @private\n   */\n  __videoBufferPromise(video, currentTime) {\n    return new Promise((resolve) => {\n      function onBuffer() {\n        const buffer = video.buffered;\n        for (let i = 0, l = buffer.length; i < l; i++) {\n          if (buffer.start(i) <= video.currentTime && buffer.end(i) >= video.currentTime) {\n            video.pause();\n            video.removeEventListener('buffer', onBuffer);\n            video.removeEventListener('progress', onBuffer);\n            resolve();\n            break;\n          }\n        }\n      }\n\n      // try to reduce the switching time by preloading in advance\n      // FIXME find a better way ?\n      video.currentTime = Math.min(currentTime + 2000, video.duration.currentTime);\n      video.muted = true;\n\n      video.addEventListener('buffer', onBuffer);\n      video.addEventListener('progress', onBuffer);\n\n      video.play();\n    });\n  }\n\n}\n","import { MathUtils, Mesh, MeshBasicMaterial, SphereGeometry } from 'three';\nimport { CONSTANTS, PSVError } from '../..';\nimport { AbstractVideoAdapter } from '../shared/AbstractVideoAdapter';\n\n/**\n * @typedef {Object} PSV.adapters.EquirectangularVideoAdapter.Video\n * @summary Object defining a video\n * @property {string} source\n */\n\n/**\n * @typedef {Object} PSV.adapters.EquirectangularVideoAdapter.Options\n * @property {boolean} [autoplay=false] - automatically start the video\n * @property {boolean} [muted=autoplay] - initially mute the video\n * @property {number} [resolution=64] - number of faces of the sphere geometry, higher values may decrease performances\n */\n\n\n/**\n * @summary Adapter for equirectangular videos\n * @memberof PSV.adapters\n * @extends PSV.adapters.AbstractAdapter\n */\nexport class EquirectangularVideoAdapter extends AbstractVideoAdapter {\n\n  static id = 'equirectangular-video';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.adapters.EquirectangularVideoAdapter.Options} options\n   */\n  constructor(psv, options) {\n    super(psv, {\n      resolution: 64,\n      ...options,\n    });\n\n    if (!MathUtils.isPowerOfTwo(this.config.resolution)) {\n      throw new PSVError('EquirectangularVideoAdapter resolution must be power of two');\n    }\n\n    this.SPHERE_SEGMENTS = this.config.resolution;\n    this.SPHERE_HORIZONTAL_SEGMENTS = this.SPHERE_SEGMENTS / 2;\n  }\n\n  /**\n   * @override\n   * @param {PSV.adapters.EquirectangularVideoAdapter.Video} panorama\n   * @returns {Promise.<PSV.TextureData>}\n   */\n  loadTexture(panorama) {\n    return super.loadTexture(panorama)\n      .then(({ texture }) => {\n        const video = texture.image;\n        const panoData = {\n          fullWidth    : video.videoWidth,\n          fullHeight   : video.videoHeight,\n          croppedWidth : video.videoWidth,\n          croppedHeight: video.videoHeight,\n          croppedX     : 0,\n          croppedY     : 0,\n          poseHeading  : 0,\n          posePitch    : 0,\n          poseRoll     : 0,\n        };\n\n        return { panorama, texture, panoData };\n      });\n  }\n\n  /**\n   * @override\n   */\n  createMesh(scale = 1) {\n    const geometry = new SphereGeometry(\n      CONSTANTS.SPHERE_RADIUS * scale,\n      this.SPHERE_SEGMENTS,\n      this.SPHERE_HORIZONTAL_SEGMENTS,\n      -Math.PI / 2\n    )\n      .scale(-1, 1, 1);\n\n    const material = new MeshBasicMaterial();\n\n    return new Mesh(geometry, material);\n  }\n\n  /**\n   * @override\n   */\n  setTexture(mesh, textureData) {\n    mesh.material.map?.dispose();\n    mesh.material.map = textureData.texture;\n\n    this.__switchVideo(textureData.texture);\n  }\n\n}\n"],"names":["AbstractVideoAdapter","psv","options","config","autoplay","muted","video","on","CONSTANTS","EVENTS","BEFORE_RENDER","destroy","off","__removeVideo","handleEvent","e","type","needsUpdate","loadTexture","panorama","source","Promise","reject","PSVError","getPlugin","__createVideo","__videoLoadPromise","then","texture","VideoTexture","__switchVideo","currentTime","duration","paused","volume","image","play","disposeTexture","textureData","pause","container","removeChild","dispose","src","document","createElement","crossOrigin","withCredentials","loop","playsinline","style","display","preload","appendChild","self","resolve","addEventListener","onLoaded","__videoBufferPromise","removeEventListener","onError","err","onBuffer","buffer","buffered","i","l","length","start","end","Math","min","AbstractAdapter","EquirectangularVideoAdapter","resolution","MathUtils","isPowerOfTwo","SPHERE_SEGMENTS","SPHERE_HORIZONTAL_SEGMENTS","panoData","fullWidth","videoWidth","fullHeight","videoHeight","croppedWidth","croppedHeight","croppedX","croppedY","poseHeading","posePitch","poseRoll","createMesh","scale","geometry","SphereGeometry","SPHERE_RADIUS","PI","material","MeshBasicMaterial","Mesh","setTexture","mesh","map","id"],"mappings":"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"}