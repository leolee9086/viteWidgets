{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import { MathUtils } from 'three';\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\nimport compass from './compass.svg';\nimport './style.scss';\n\n\n/**\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\n * @property {string} [size='120px'] - size of the compass\n * @property {string} [position='top left'] - position of the compass\n * @property {string} [backgroundSvg] - SVG used as background of the compass\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\n * @type {string} [color] - override the global \"hotspotColor\"\n */\n\n\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\n\n\n/**\n * @summary Adds a compass on the viewer\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class CompassPlugin extends AbstractPlugin {\n\n  static id = 'compass';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.CompassPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.plugins.CompassPlugin.Options}\n     * @private\n     */\n    this.config = {\n      size           : '120px',\n      backgroundSvg  : compass,\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\n      navigation     : true,\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\n      ...options,\n      position       : utils.cleanPosition(options.position, { allowCenter: true, cssOrder: true }) || ['top', 'left'],\n    };\n\n    /**\n     * @private\n     */\n    this.prop = {\n      visible  : true,\n      mouse    : null,\n      mouseDown: false,\n      markers  : [],\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n\n    /**\n     * @member {HTMLElement}\n     * @readonly\n     * @private\n     */\n    this.container = document.createElement('div');\n    this.container.className = `psv-compass psv-compass--${this.config.position.join('-')}`;\n    this.container.innerHTML = this.config.backgroundSvg;\n\n    this.container.style.width = this.config.size;\n    this.container.style.height = this.config.size;\n    if (this.config.position[0] === 'center') {\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\n    }\n    if (this.config.position[1] === 'center') {\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\n    }\n\n    /**\n     * @member {HTMLCanvasElement}\n     * @readonly\n     * @private\n     */\n    this.canvas = document.createElement('canvas');\n\n    this.container.appendChild(this.canvas);\n\n    if (this.config.navigation) {\n      this.container.addEventListener('mouseenter', this);\n      this.container.addEventListener('mouseleave', this);\n      this.container.addEventListener('mousemove', this);\n      this.container.addEventListener('mousedown', this);\n      this.container.addEventListener('mouseup', this);\n      this.container.addEventListener('touchstart', this);\n      this.container.addEventListener('touchmove', this);\n      this.container.addEventListener('touchend', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    this.psv.container.appendChild(this.container);\n\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\n\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.on('set-markers', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.off('set-markers', this);\n    }\n\n    this.psv.container.removeChild(this.container);\n\n    delete this.canvas;\n    delete this.container;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.RENDER:\n        this.__update();\n        break;\n      case 'set-markers':\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\n        this.__update();\n        break;\n      case 'mouseenter':\n      case 'mousemove':\n      case 'touchmove':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        if (this.prop.mouseDown) {\n          this.__click();\n        }\n        else {\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mousedown':\n      case 'touchstart':\n        this.prop.mouseDown = true;\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseup':\n      case 'touchend':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        this.prop.mouseDown = false;\n        this.__click();\n        if (e.changedTouches) {\n          this.prop.mouse = null;\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseleave':\n        this.prop.mouse = null;\n        this.prop.mouseDown = false;\n        this.__update();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Hides the compass\n   */\n  hide() {\n    this.container.style.display = 'none';\n    this.prop.visible = false;\n  }\n\n  /**\n   * @summary Shows the compass\n   */\n  show() {\n    this.container.style.display = '';\n    this.prop.visible = true;\n  }\n\n  /**\n   * @summary Changes the hotspots on the compass\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\n   */\n  setHotspots(hotspots) {\n    this.config.hotspots = hotspots;\n    this.__update();\n  }\n\n  /**\n   * @summary Removes all hotspots\n   */\n  clearHotspots() {\n    this.setHotspots(null);\n  }\n\n  /**\n   * @summary Updates the compass for current zoom and position\n   * @private\n   */\n  __update() {\n    const context = this.canvas.getContext('2d');\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    const longitude = this.psv.getPosition().longitude;\n    const fov = MathUtils.degToRad(this.psv.prop.hFov);\n\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\n\n    const mouseAngle = this.__getMouseAngle();\n    if (mouseAngle !== null) {\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\n    }\n\n    this.prop.markers.forEach((marker) => {\n      this.__drawMarker(context, marker);\n    });\n    this.config.hotspots?.forEach((spot) => {\n      if ('longitude' in spot && !('latitude' in spot)) {\n        spot.latitude = 0;\n      }\n      const pos = this.psv.dataHelper.cleanPosition(spot);\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\n    });\n  }\n\n  /**\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\n   * @private\n   */\n  __click() {\n    const mouseAngle = this.__getMouseAngle();\n\n    if (mouseAngle !== null) {\n      this.psv.rotate({\n        longitude: mouseAngle,\n        latitude : 0,\n      });\n    }\n  }\n\n  /**\n   * @summary Draw a cone\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} fov\n   * @private\n   */\n  __drawCone(context, color, longitude, fov) {\n    const a1 = longitude - Math.PI / 2 - fov / 2;\n    const a2 = a1 + fov;\n    const c = this.canvas.width / 2;\n\n    context.beginPath();\n    context.moveTo(c, c);\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\n    context.arc(c, c, c, a1, a2, false);\n    context.lineTo(c, c);\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Draw a Marker\n   * @param {CanvasRenderingContext2D} context\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\n   * @private\n   */\n  __drawMarker(context, marker) {\n    let color = this.config.hotspotColor;\n    if (typeof marker.data.compass === 'string') {\n      color = marker.data.compass;\n    }\n\n    if (marker.isPoly()) {\n      context.beginPath();\n      marker.props.def.forEach(([longitude, latitude], i) => {\n        const a = longitude - Math.PI / 2;\n        const d = (latitude + Math.PI / 2) / Math.PI;\n        const c = this.canvas.width / 2;\n\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\n      });\n      if (marker.isPolygon()) {\n        context.fillStyle = color;\n        context.fill();\n      }\n      else {\n        context.strokeStyle = color;\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\n        context.stroke();\n      }\n    }\n    else {\n      const pos = marker.props.position;\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\n    }\n  }\n\n  /**\n   * @summary Draw a point\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} latitude - in viewer reference\n   * @private\n   */\n  __drawPoint(context, color, longitude, latitude) {\n    const a = longitude - Math.PI / 2;\n    const d = (latitude + Math.PI / 2) / Math.PI;\n    const c = this.canvas.width / 2;\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\n\n    context.beginPath();\n    context.ellipse(\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\n      r, r,\n      0, 0, Math.PI * 2\n    );\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Gets the longitude corresponding to the mouse position on the compass\n   * @return {number | null}\n   * @private\n   */\n  __getMouseAngle() {\n    if (!this.prop.mouse) {\n      return null;\n    }\n\n    const boundingRect = this.container.getBoundingClientRect();\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\n\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\n      return null;\n    }\n\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\n  }\n\n}\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","position","utils","cleanPosition","allowCenter","cssOrder","prop","visible","mouse","mouseDown","markers","container","document","createElement","className","join","innerHTML","style","width","height","marginTop","marginLeft","canvas","appendChild","addEventListener","init","getPlugin","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","changedTouches","__click","stopPropagation","preventDefault","hide","display","show","setHotspots","hotspots","clearHotspots","context","getContext","clearRect","longitude","getPosition","fov","MathUtils","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","Math","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;EAMA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;;EAGA,IAAMA,kBAAkB,GAAG,CAAA,GAAI,EAA/B,CAAA;EAGA;EACA;EACA;EACA;EACA;;AACA,MAAaC,aAAb,gBAAA,UAAA,eAAA,EAAA;EAAA,EAAA,cAAA,CAAA,aAAA,EAAA,eAAA,CAAA,CAAA;;EAIE;EACF;EACA;EACA;IACE,SAAYC,aAAAA,CAAAA,GAAZ,EAAiBC,OAAjB,EAA0B;EAAA,IAAA,IAAA,KAAA,CAAA;;EACxB,IAAA,KAAA,GAAA,eAAA,CAAA,IAAA,CAAA,IAAA,EAAMD,GAAN,CAAA,IAAA,IAAA,CAAA;EAEA;EACJ;EACA;EACA;;EACI,IAAA,KAAA,CAAKE,MAAL,GAAA,QAAA,CAAA;EACEC,MAAAA,IAAI,EAAa,OADnB;EAEEC,MAAAA,aAAa,EAAIC,OAFnB;EAGEC,MAAAA,SAAS,EAAQ,0BAHnB;EAIEC,MAAAA,UAAU,EAAO,IAJnB;EAKEC,MAAAA,eAAe,EAAE,sBALnB;EAMEC,MAAAA,YAAY,EAAK,oBAAA;EANnB,KAAA,EAOKR,OAPL,EAAA;QAQES,QAAQ,EAASC,uBAAK,CAACC,aAAN,CAAoBX,OAAO,CAACS,QAA5B,EAAsC;EAAEG,QAAAA,WAAW,EAAE,IAAf;EAAqBC,QAAAA,QAAQ,EAAE,IAAA;EAA/B,OAAtC,CAAgF,IAAA,CAAC,KAAD,EAAQ,MAAR,CAAA;EARnG,KAAA,CAAA,CAAA;EAWA;EACJ;EACA;;EACI,IAAA,KAAA,CAAKC,IAAL,GAAY;EACVC,MAAAA,OAAO,EAAI,IADD;EAEVC,MAAAA,KAAK,EAAM,IAFD;EAGVC,MAAAA,SAAS,EAAE,KAHD;EAIVC,MAAAA,OAAO,EAAI,EAAA;OAJb,CAAA;EAOA;EACJ;EACA;EACA;;MACI,KAAKA,CAAAA,OAAL,GAAe,IAAf,CAAA;EAEA;EACJ;EACA;EACA;EACA;;EACI,IAAA,KAAA,CAAKC,SAAL,GAAiBC,QAAQ,CAACC,aAAT,CAAuB,KAAvB,CAAjB,CAAA;EACA,IAAA,KAAA,CAAKF,SAAL,CAAeG,SAAf,GAAA,2BAAA,GAAuD,KAAKrB,CAAAA,MAAL,CAAYQ,QAAZ,CAAqBc,IAArB,CAA0B,GAA1B,CAAvD,CAAA;EACA,IAAA,KAAA,CAAKJ,SAAL,CAAeK,SAAf,GAA2B,KAAKvB,CAAAA,MAAL,CAAYE,aAAvC,CAAA;MAEA,KAAKgB,CAAAA,SAAL,CAAeM,KAAf,CAAqBC,KAArB,GAA6B,KAAA,CAAKzB,MAAL,CAAYC,IAAzC,CAAA;MACA,KAAKiB,CAAAA,SAAL,CAAeM,KAAf,CAAqBE,MAArB,GAA8B,KAAA,CAAK1B,MAAL,CAAYC,IAA1C,CAAA;;MACA,IAAI,KAAA,CAAKD,MAAL,CAAYQ,QAAZ,CAAqB,CAArB,CAAA,KAA4B,QAAhC,EAA0C;QACxC,KAAKU,CAAAA,SAAL,CAAeM,KAAf,CAAqBG,SAArB,GAA0C,QAAA,GAAA,KAAA,CAAK3B,MAAL,CAAYC,IAAtD,GAAA,OAAA,CAAA;EACD,KAAA;;MACD,IAAI,KAAA,CAAKD,MAAL,CAAYQ,QAAZ,CAAqB,CAArB,CAAA,KAA4B,QAAhC,EAA0C;QACxC,KAAKU,CAAAA,SAAL,CAAeM,KAAf,CAAqBI,UAArB,GAA2C,QAAA,GAAA,KAAA,CAAK5B,MAAL,CAAYC,IAAvD,GAAA,OAAA,CAAA;EACD,KAAA;EAED;EACJ;EACA;EACA;EACA;;;EACI,IAAA,KAAA,CAAK4B,MAAL,GAAcV,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAd,CAAA;;EAEA,IAAA,KAAA,CAAKF,SAAL,CAAeY,WAAf,CAA2B,MAAKD,MAAhC,CAAA,CAAA;;EAEA,IAAA,IAAI,KAAK7B,CAAAA,MAAL,CAAYK,UAAhB,EAA4B;EAC1B,MAAA,KAAA,CAAKa,SAAL,CAAea,gBAAf,CAAgC,YAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,YAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,WAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,WAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,SAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,YAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,WAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;;EACA,MAAA,KAAA,CAAKb,SAAL,CAAea,gBAAf,CAAgC,UAAhC,EAAA,sBAAA,CAAA,KAAA,CAAA,CAAA,CAAA;EACD,KAAA;;EAtEuB,IAAA,OAAA,KAAA,CAAA;EAuEzB,GAAA;EAED;EACF;EACA;;;EAnFA,EAAA,IAAA,MAAA,GAAA,aAAA,CAAA,SAAA,CAAA;;IAAA,MAoFEC,CAAAA,IApFF,GAoFE,SAAO,IAAA,GAAA;EACL,IAAA,eAAA,CAAA,SAAA,CAAMA,IAAN,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA;;MAEA,IAAKf,CAAAA,OAAL,GAAe,IAAKnB,CAAAA,GAAL,CAASmC,SAAT,CAAmB,SAAnB,CAAf,CAAA;EAEA,IAAA,IAAA,CAAKnC,GAAL,CAASoB,SAAT,CAAmBY,WAAnB,CAA+B,KAAKZ,SAApC,CAAA,CAAA;MAEA,IAAKW,CAAAA,MAAL,CAAYJ,KAAZ,GAAoB,IAAA,CAAKP,SAAL,CAAegB,WAAf,GAA6BC,wBAAM,CAACC,UAAxD,CAAA;MACA,IAAKP,CAAAA,MAAL,CAAYH,MAAZ,GAAqB,IAAA,CAAKR,SAAL,CAAegB,WAAf,GAA6BC,wBAAM,CAACC,UAAzD,CAAA;MAEA,IAAKtC,CAAAA,GAAL,CAASuC,EAAT,CAAYC,2BAAS,CAACC,MAAV,CAAiBC,MAA7B,EAAqC,IAArC,CAAA,CAAA;;MAEA,IAAI,IAAA,CAAKvB,OAAT,EAAkB;EAChB,MAAA,IAAA,CAAKA,OAAL,CAAaoB,EAAb,CAAgB,aAAhB,EAA+B,IAA/B,CAAA,CAAA;EACD,KAAA;EACF,GAAA;EAED;EACF;EACA;EAvGA,GAAA;;IAAA,MAwGEI,CAAAA,OAxGF,GAwGE,SAAU,OAAA,GAAA;MACR,IAAK3C,CAAAA,GAAL,CAAS4C,GAAT,CAAaJ,2BAAS,CAACC,MAAV,CAAiBC,MAA9B,EAAsC,IAAtC,CAAA,CAAA;;MAEA,IAAI,IAAA,CAAKvB,OAAT,EAAkB;EAChB,MAAA,IAAA,CAAKA,OAAL,CAAayB,GAAb,CAAiB,aAAjB,EAAgC,IAAhC,CAAA,CAAA;EACD,KAAA;;EAED,IAAA,IAAA,CAAK5C,GAAL,CAASoB,SAAT,CAAmByB,WAAnB,CAA+B,KAAKzB,SAApC,CAAA,CAAA;EAEA,IAAA,OAAO,KAAKW,MAAZ,CAAA;EACA,IAAA,OAAO,KAAKX,SAAZ,CAAA;;EAEA,IAAA,eAAA,CAAA,SAAA,CAAMuB,OAAN,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA;EACD,GAAA;EAED;EACF;EACA;EAzHA,GAAA;;EAAA,EAAA,MAAA,CA0HEG,WA1HF,GA0HE,SAAYC,WAAAA,CAAAA,CAAZ,EAAe;EAAA,IAAA,IAAA,iBAAA,EAAA,kBAAA,CAAA;;MACb,QAAQA,CAAC,CAACC,IAAV;EACE,MAAA,KAAKR,2BAAS,CAACC,MAAV,CAAiBC,MAAtB;EACE,QAAA,IAAA,CAAKO,QAAL,EAAA,CAAA;;EACA,QAAA,MAAA;;EACF,MAAA,KAAK,aAAL;EACE,QAAA,IAAA,CAAKlC,IAAL,CAAUI,OAAV,GAAoB4B,CAAC,CAACG,IAAF,CAAO,CAAP,CAAA,CAAUC,MAAV,CAAiB,UAAAC,CAAC,EAAA;EAAA,UAAA,IAAA,OAAA,CAAA;;EAAA,UAAA,OAAA,CAAA,OAAA,GAAIA,CAAC,CAACC,IAAN,KAAA,IAAA,GAAA,KAAA,CAAA,GAAI,QAAQhD,OAAZ,CAAA;EAAA,SAAlB,CAApB,CAAA;;EACA,QAAA,IAAA,CAAK4C,QAAL,EAAA,CAAA;;EACA,QAAA,MAAA;;EACF,MAAA,KAAK,YAAL,CAAA;EACA,MAAA,KAAK,WAAL,CAAA;EACA,MAAA,KAAK,WAAL;UACE,IAAKlC,CAAAA,IAAL,CAAUE,KAAV,GAAkB,CAAA,CAAA,iBAAA,GAAA8B,CAAC,CAACO,cAAF,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,iBAAA,CAAmB,CAAnB,CAAA,KAAyBP,CAA3C,CAAA;;EACA,QAAA,IAAI,IAAKhC,CAAAA,IAAL,CAAUG,SAAd,EAAyB;EACvB,UAAA,IAAA,CAAKqC,OAAL,EAAA,CAAA;EACD,SAFD,MAGK;EACH,UAAA,IAAA,CAAKN,QAAL,EAAA,CAAA;EACD,SAAA;;EACDF,QAAAA,CAAC,CAACS,eAAF,EAAA,CAAA;EACAT,QAAAA,CAAC,CAACU,cAAF,EAAA,CAAA;EACA,QAAA,MAAA;;EACF,MAAA,KAAK,WAAL,CAAA;EACA,MAAA,KAAK,YAAL;EACE,QAAA,IAAA,CAAK1C,IAAL,CAAUG,SAAV,GAAsB,IAAtB,CAAA;EACA6B,QAAAA,CAAC,CAACS,eAAF,EAAA,CAAA;EACAT,QAAAA,CAAC,CAACU,cAAF,EAAA,CAAA;EACA,QAAA,MAAA;;EACF,MAAA,KAAK,SAAL,CAAA;EACA,MAAA,KAAK,UAAL;UACE,IAAK1C,CAAAA,IAAL,CAAUE,KAAV,GAAkB,CAAA,CAAA,kBAAA,GAAA8B,CAAC,CAACO,cAAF,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,kBAAA,CAAmB,CAAnB,CAAA,KAAyBP,CAA3C,CAAA;EACA,QAAA,IAAA,CAAKhC,IAAL,CAAUG,SAAV,GAAsB,KAAtB,CAAA;;EACA,QAAA,IAAA,CAAKqC,OAAL,EAAA,CAAA;;UACA,IAAIR,CAAC,CAACO,cAAN,EAAsB;EACpB,UAAA,IAAA,CAAKvC,IAAL,CAAUE,KAAV,GAAkB,IAAlB,CAAA;;EACA,UAAA,IAAA,CAAKgC,QAAL,EAAA,CAAA;EACD,SAAA;;EACDF,QAAAA,CAAC,CAACS,eAAF,EAAA,CAAA;EACAT,QAAAA,CAAC,CAACU,cAAF,EAAA,CAAA;EACA,QAAA,MAAA;;EACF,MAAA,KAAK,YAAL;EACE,QAAA,IAAA,CAAK1C,IAAL,CAAUE,KAAV,GAAkB,IAAlB,CAAA;EACA,QAAA,IAAA,CAAKF,IAAL,CAAUG,SAAV,GAAsB,KAAtB,CAAA;;EACA,QAAA,IAAA,CAAK+B,QAAL,EAAA,CAAA;;EACA,QAAA,MAAA;EA3CJ,KAAA;EA+CD,GAAA;EAED;EACF;EACA;EA9KA,GAAA;;IAAA,MA+KES,CAAAA,IA/KF,GA+KE,SAAO,IAAA,GAAA;EACL,IAAA,IAAA,CAAKtC,SAAL,CAAeM,KAAf,CAAqBiC,OAArB,GAA+B,MAA/B,CAAA;EACA,IAAA,IAAA,CAAK5C,IAAL,CAAUC,OAAV,GAAoB,KAApB,CAAA;EACD,GAAA;EAED;EACF;EACA;EAtLA,GAAA;;IAAA,MAuLE4C,CAAAA,IAvLF,GAuLE,SAAO,IAAA,GAAA;EACL,IAAA,IAAA,CAAKxC,SAAL,CAAeM,KAAf,CAAqBiC,OAArB,GAA+B,EAA/B,CAAA;EACA,IAAA,IAAA,CAAK5C,IAAL,CAAUC,OAAV,GAAoB,IAApB,CAAA;EACD,GAAA;EAED;EACF;EACA;EACA;EA/LA,GAAA;;EAAA,EAAA,MAAA,CAgME6C,WAhMF,GAgME,SAAYC,WAAAA,CAAAA,QAAZ,EAAsB;EACpB,IAAA,IAAA,CAAK5D,MAAL,CAAY4D,QAAZ,GAAuBA,QAAvB,CAAA;;EACA,IAAA,IAAA,CAAKb,QAAL,EAAA,CAAA;EACD,GAAA;EAED;EACF;EACA;EAvMA,GAAA;;IAAA,MAwMEc,CAAAA,aAxMF,GAwME,SAAgB,aAAA,GAAA;MACd,IAAKF,CAAAA,WAAL,CAAiB,IAAjB,CAAA,CAAA;EACD,GAAA;EAED;EACF;EACA;EACA;EA/MA,GAAA;;IAAA,MAgNEZ,CAAAA,QAhNF,GAgNE,SAAW,QAAA,GAAA;EAAA,IAAA,IAAA,MAAA,GAAA,IAAA;EAAA,QAAA,qBAAA,CAAA;;MACT,IAAMe,OAAO,GAAG,IAAKjC,CAAAA,MAAL,CAAYkC,UAAZ,CAAuB,IAAvB,CAAhB,CAAA;EACAD,IAAAA,OAAO,CAACE,SAAR,CAAkB,CAAlB,EAAqB,CAArB,EAAwB,IAAKnC,CAAAA,MAAL,CAAYJ,KAApC,EAA2C,IAAKI,CAAAA,MAAL,CAAYH,MAAvD,CAAA,CAAA;EAEA,IAAA,IAAMuC,SAAS,GAAG,IAAA,CAAKnE,GAAL,CAASoE,WAAT,GAAuBD,SAAzC,CAAA;EACA,IAAA,IAAME,GAAG,GAAGC,eAAS,CAACC,QAAV,CAAmB,IAAKvE,CAAAA,GAAL,CAASe,IAAT,CAAcyD,IAAjC,CAAZ,CAAA;;MAEA,IAAKC,CAAAA,UAAL,CAAgBT,OAAhB,EAAyB,IAAA,CAAK9D,MAAL,CAAYI,SAArC,EAAgD6D,SAAhD,EAA2DE,GAA3D,CAAA,CAAA;;EAEA,IAAA,IAAMK,UAAU,GAAG,IAAKC,CAAAA,eAAL,EAAnB,CAAA;;MACA,IAAID,UAAU,KAAK,IAAnB,EAAyB;QACvB,IAAKD,CAAAA,UAAL,CAAgBT,OAAhB,EAAyB,IAAA,CAAK9D,MAAL,CAAYM,eAArC,EAAsDkE,UAAtD,EAAkEL,GAAlE,CAAA,CAAA;EACD,KAAA;;MAED,IAAKtD,CAAAA,IAAL,CAAUI,OAAV,CAAkByD,OAAlB,CAA0B,UAACC,MAAD,EAAY;EACpC,MAAA,MAAI,CAACC,YAAL,CAAkBd,OAAlB,EAA2Ba,MAA3B,CAAA,CAAA;OADF,CAAA,CAAA;MAGA,CAAK3E,qBAAAA,GAAAA,IAAAA,CAAAA,MAAL,CAAY4D,QAAZ,KAAA,IAAA,GAAA,KAAA,CAAA,GAAA,qBAAA,CAAsBc,OAAtB,CAA8B,UAACG,IAAD,EAAU;EACtC,MAAA,IAAI,eAAeA,IAAf,IAAuB,EAAE,UAAcA,IAAAA,IAAhB,CAA3B,EAAkD;UAChDA,IAAI,CAACC,QAAL,GAAgB,CAAhB,CAAA;EACD,OAAA;;QACD,IAAMC,GAAG,GAAG,MAAI,CAACjF,GAAL,CAASkF,UAAT,CAAoBtE,aAApB,CAAkCmE,IAAlC,CAAZ,CAAA;;QACA,MAAI,CAACI,WAAL,CAAiBnB,OAAjB,EAA0Be,IAAI,CAACK,KAAL,IAAc,MAAI,CAAClF,MAAL,CAAYO,YAApD,EAAkEwE,GAAG,CAACd,SAAtE,EAAiFc,GAAG,CAACD,QAArF,CAAA,CAAA;OALF,CAAA,CAAA;EAOD,GAAA;EAED;EACF;EACA;EACA;EA7OA,GAAA;;IAAA,MA8OEzB,CAAAA,OA9OF,GA8OE,SAAU,OAAA,GAAA;EACR,IAAA,IAAMmB,UAAU,GAAG,IAAKC,CAAAA,eAAL,EAAnB,CAAA;;MAEA,IAAID,UAAU,KAAK,IAAnB,EAAyB;QACvB,IAAK1E,CAAAA,GAAL,CAASqF,MAAT,CAAgB;EACdlB,QAAAA,SAAS,EAAEO,UADG;EAEdM,QAAAA,QAAQ,EAAG,CAAA;SAFb,CAAA,CAAA;EAID,KAAA;EACF,GAAA;EAED;EACF;EACA;EACA;EACA;EACA;EACA;EACA;EAhQA,GAAA;;IAAA,MAiQEP,CAAAA,UAjQF,GAiQE,SAAA,UAAA,CAAWT,OAAX,EAAoBoB,KAApB,EAA2BjB,SAA3B,EAAsCE,GAAtC,EAA2C;EACzC,IAAA,IAAMiB,EAAE,GAAGnB,SAAS,GAAGoB,IAAI,CAACC,EAAL,GAAU,CAAtB,GAA0BnB,GAAG,GAAG,CAA3C,CAAA;EACA,IAAA,IAAMoB,EAAE,GAAGH,EAAE,GAAGjB,GAAhB,CAAA;EACA,IAAA,IAAMqB,CAAC,GAAG,IAAA,CAAK3D,MAAL,CAAYJ,KAAZ,GAAoB,CAA9B,CAAA;EAEAqC,IAAAA,OAAO,CAAC2B,SAAR,EAAA,CAAA;EACA3B,IAAAA,OAAO,CAAC4B,MAAR,CAAeF,CAAf,EAAkBA,CAAlB,CAAA,CAAA;MACA1B,OAAO,CAAC6B,MAAR,CAAeH,CAAC,GAAGH,IAAI,CAACO,GAAL,CAASR,EAAT,IAAeI,CAAlC,EAAqCA,CAAC,GAAGH,IAAI,CAACQ,GAAL,CAAST,EAAT,CAAA,GAAeI,CAAxD,CAAA,CAAA;EACA1B,IAAAA,OAAO,CAACgC,GAAR,CAAYN,CAAZ,EAAeA,CAAf,EAAkBA,CAAlB,EAAqBJ,EAArB,EAAyBG,EAAzB,EAA6B,KAA7B,CAAA,CAAA;EACAzB,IAAAA,OAAO,CAAC6B,MAAR,CAAeH,CAAf,EAAkBA,CAAlB,CAAA,CAAA;MACA1B,OAAO,CAACiC,SAAR,GAAoBb,KAApB,CAAA;EACApB,IAAAA,OAAO,CAACkC,IAAR,EAAA,CAAA;EACD,GAAA;EAED;EACF;EACA;EACA;EACA;EACA;EApRA,GAAA;;EAAA,EAAA,MAAA,CAqREpB,YArRF,GAqRE,SAAA,YAAA,CAAad,OAAb,EAAsBa,MAAtB,EAA8B;EAAA,IAAA,IAAA,MAAA,GAAA,IAAA,CAAA;;EAC5B,IAAA,IAAIO,KAAK,GAAG,IAAKlF,CAAAA,MAAL,CAAYO,YAAxB,CAAA;;MACA,IAAI,OAAOoE,MAAM,CAACxB,IAAP,CAAYhD,OAAnB,KAA+B,QAAnC,EAA6C;EAC3C+E,MAAAA,KAAK,GAAGP,MAAM,CAACxB,IAAP,CAAYhD,OAApB,CAAA;EACD,KAAA;;EAED,IAAA,IAAIwE,MAAM,CAACsB,MAAP,EAAJ,EAAqB;EACnBnC,MAAAA,OAAO,CAAC2B,SAAR,EAAA,CAAA;QACAd,MAAM,CAACuB,KAAP,CAAaC,GAAb,CAAiBzB,OAAjB,CAAyB,UAAwB0B,IAAAA,EAAAA,CAAxB,EAA8B;EAAA,QAAA,IAA5BnC,SAA4B,GAAA,IAAA,CAAA,CAAA,CAAA;EAAA,YAAjBa,QAAiB,GAAA,IAAA,CAAA,CAAA,CAAA,CAAA;UACrD,IAAMuB,CAAC,GAAGpC,SAAS,GAAGoB,IAAI,CAACC,EAAL,GAAU,CAAhC,CAAA;EACA,QAAA,IAAMgB,CAAC,GAAG,CAACxB,QAAQ,GAAGO,IAAI,CAACC,EAAL,GAAU,CAAtB,IAA2BD,IAAI,CAACC,EAA1C,CAAA;UACA,IAAME,CAAC,GAAG,MAAI,CAAC3D,MAAL,CAAYJ,KAAZ,GAAoB,CAA9B,CAAA;EAEAqC,QAAAA,OAAO,CAACsC,CAAC,KAAK,CAAN,GAAU,QAAV,GAAqB,QAAtB,CAAP,CAAuCZ,CAAC,GAAGH,IAAI,CAACO,GAAL,CAASS,CAAT,CAAA,GAAcb,CAAd,GAAkBc,CAA7D,EAAgEd,CAAC,GAAGH,IAAI,CAACQ,GAAL,CAASQ,CAAT,CAAcb,GAAAA,CAAd,GAAkBc,CAAtF,CAAA,CAAA;SALF,CAAA,CAAA;;EAOA,MAAA,IAAI3B,MAAM,CAAC4B,SAAP,EAAJ,EAAwB;UACtBzC,OAAO,CAACiC,SAAR,GAAoBb,KAApB,CAAA;EACApB,QAAAA,OAAO,CAACkC,IAAR,EAAA,CAAA;EACD,OAHD,MAIK;UACHlC,OAAO,CAAC0C,WAAR,GAAsBtB,KAAtB,CAAA;EACApB,QAAAA,OAAO,CAAC2C,SAAR,GAAoBpB,IAAI,CAACqB,GAAL,CAAS,CAAT,EAAY,IAAA,CAAK7E,MAAL,CAAYJ,KAAZ,GAAoB7B,kBAApB,GAAyC,CAArD,CAApB,CAAA;EACAkE,QAAAA,OAAO,CAAC6C,MAAR,EAAA,CAAA;EACD,OAAA;EACF,KAlBD,MAmBK;EACH,MAAA,IAAM5B,GAAG,GAAGJ,MAAM,CAACuB,KAAP,CAAa1F,QAAzB,CAAA;;EACA,MAAA,IAAA,CAAKyE,WAAL,CAAiBnB,OAAjB,EAA0BoB,KAA1B,EAAiCH,GAAG,CAACd,SAArC,EAAgDc,GAAG,CAACD,QAApD,CAAA,CAAA;EACD,KAAA;EACF,GAAA;EAED;EACF;EACA;EACA;EACA;EACA;EACA;EACA;EA3TA,GAAA;;IAAA,MA4TEG,CAAAA,WA5TF,GA4TE,SAAA,WAAA,CAAYnB,OAAZ,EAAqBoB,KAArB,EAA4BjB,SAA5B,EAAuCa,QAAvC,EAAiD;MAC/C,IAAMuB,CAAC,GAAGpC,SAAS,GAAGoB,IAAI,CAACC,EAAL,GAAU,CAAhC,CAAA;EACA,IAAA,IAAMgB,CAAC,GAAG,CAACxB,QAAQ,GAAGO,IAAI,CAACC,EAAL,GAAU,CAAtB,IAA2BD,IAAI,CAACC,EAA1C,CAAA;EACA,IAAA,IAAME,CAAC,GAAG,IAAA,CAAK3D,MAAL,CAAYJ,KAAZ,GAAoB,CAA9B,CAAA;EACA,IAAA,IAAMmF,CAAC,GAAGvB,IAAI,CAACqB,GAAL,CAAS,CAAT,EAAY,IAAA,CAAK7E,MAAL,CAAYJ,KAAZ,GAAoB7B,kBAAhC,CAAV,CAAA;EAEAkE,IAAAA,OAAO,CAAC2B,SAAR,EAAA,CAAA;EACA3B,IAAAA,OAAO,CAAC+C,OAAR,CACErB,CAAC,GAAGH,IAAI,CAACO,GAAL,CAASS,CAAT,IAAcb,CAAd,GAAkBc,CADxB,EAC2Bd,CAAC,GAAGH,IAAI,CAACQ,GAAL,CAASQ,CAAT,CAAcb,GAAAA,CAAd,GAAkBc,CADjD,EAEEM,CAFF,EAEKA,CAFL,EAGE,CAHF,EAGK,CAHL,EAGQvB,IAAI,CAACC,EAAL,GAAU,CAHlB,CAAA,CAAA;MAKAxB,OAAO,CAACiC,SAAR,GAAoBb,KAApB,CAAA;EACApB,IAAAA,OAAO,CAACkC,IAAR,EAAA,CAAA;EACD,GAAA;EAED;EACF;EACA;EACA;EACA;EAhVA,GAAA;;IAAA,MAiVEvB,CAAAA,eAjVF,GAiVE,SAAkB,eAAA,GAAA;EAChB,IAAA,IAAI,CAAC,IAAA,CAAK5D,IAAL,CAAUE,KAAf,EAAsB;EACpB,MAAA,OAAO,IAAP,CAAA;EACD,KAAA;;EAED,IAAA,IAAM+F,YAAY,GAAG,IAAA,CAAK5F,SAAL,CAAe6F,qBAAf,EAArB,CAAA;EACA,IAAA,IAAMC,MAAM,GAAG,IAAA,CAAKnG,IAAL,CAAUE,KAAV,CAAgBkG,OAAhB,GAA0BH,YAAY,CAACI,IAAvC,GAA8CJ,YAAY,CAACrF,KAAb,GAAqB,CAAlF,CAAA;EACA,IAAA,IAAM0F,MAAM,GAAG,IAAA,CAAKtG,IAAL,CAAUE,KAAV,CAAgBqG,OAAhB,GAA0BN,YAAY,CAACO,GAAvC,GAA6CP,YAAY,CAACrF,KAAb,GAAqB,CAAjF,CAAA;;EAEA,IAAA,IAAI4D,IAAI,CAACiC,IAAL,CAAUN,MAAM,GAAGA,MAAT,GAAkBG,MAAM,GAAGA,MAArC,CAA+CL,GAAAA,YAAY,CAACrF,KAAb,GAAqB,CAAxE,EAA2E;EACzE,MAAA,OAAO,IAAP,CAAA;EACD,KAAA;;EAED,IAAA,OAAO4D,IAAI,CAACkC,KAAL,CAAWJ,MAAX,EAAmBH,MAAnB,CAAA,GAA6B3B,IAAI,CAACC,EAAL,GAAU,CAA9C,CAAA;KA9VJ,CAAA;;EAAA,EAAA,OAAA,aAAA,CAAA;EAAA,CAAA,CAAmCkC,gCAAnC,EAAA;EAAa3H,cAEJ4H,KAAK;;;;;;;;;;"}